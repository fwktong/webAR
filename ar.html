<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>AR Áõ∏Ê©ü - Êì¥Â¢ûÂØ¶Â¢ÉÈ´îÈ©ó</title>
    
    <!-- A-Frame Âíå AR.js -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <link rel="stylesheet" href="styles.css">
</head>
<body class="ar-page">
    
    <!-- ËºâÂÖ•Áï´Èù¢ -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="loader"></div>
            <p class="loading-text">Ê≠£Âú®ÂïüÂãï AR Áõ∏Ê©ü...</p>
            <p class="loading-hint">Ë´ãÂÖÅË®±Áõ∏Ê©üÊ¨äÈôê</p>
        </div>
    </div>

    <!-- AR Â†¥ÊôØ -->
    <a-scene
        id="arScene"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; trackingMethod: best;"
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; precision: medium; antialias: true; alpha: true;"
        loading-screen="enabled: false">
        
        <!-- Ë≥áÊ∫êÈ†êËºâ -->
        <a-assets>
            <!-- Á∂†ÂπïÂΩ±Áâá - ‰ΩøÁî®ÁØÑ‰æãÂΩ±Áâá -->
            <video 
                id="greenScreenVideo" 
                src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerEscapes.mp4"
                preload="auto" 
                loop="true" 
                crossorigin="anonymous"
                playsinline
                webkit-playsinline
                muted>
            </video>
        </a-assets>

        <!-- AR Áõ∏Ê©ü -->
        <a-entity camera></a-entity>

        <!-- Hiro Ê®ôË®ò -->
        <a-marker preset="hiro" id="hiroMarker">
            <!-- Á∂†ÂπïÂΩ±ÁâáÂπ≥Èù¢ -->
            <a-plane
                id="videoPlane"
                position="0 0 0"
                rotation="-90 0 0"
                width="1.6"
                height="0.9"
                material="shader: chromakey; src: #greenScreenVideo; color: 0.1 0.9 0.2; transparent: true; opacity: 1;">
            </a-plane>
            
            <!-- ÈÇäÊ°ÜÊåáÁ§∫Âô® -->
            <a-box 
                position="0 0.05 0" 
                scale="1.7 0.1 1" 
                material="color: #00f5ff; opacity: 0.3; transparent: true;"
                animation="property: material.opacity; from: 0.3; to: 0.6; dur: 1000; dir: alternate; loop: true;">
            </a-box>
        </a-marker>
    </a-scene>

    <!-- UI ÊéßÂà∂Â±§ -->
    <div id="arUI" class="ar-ui hidden">
        <!-- È†ÇÈÉ®ÁãÄÊÖãÂàó -->
        <div class="top-bar">
            <button id="backBtn" class="control-btn back-btn">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>ËøîÂõû</span>
            </button>
            
            <div id="markerStatus" class="marker-status">
                <span class="status-dot"></span>
                <span class="status-text">Â∞ãÊâæÊ®ôË®ò‰∏≠...</span>
            </div>
        </div>

        <!-- ÈåÑÂΩ±Ë®àÊôÇÂô® -->
        <div id="recordingTimer" class="recording-timer hidden">
            <span class="recording-dot"></span>
            <span id="timerText">00:00</span>
            <span class="timer-limit">/ 00:30</span>
        </div>

        <!-- Â∫ïÈÉ®ÊéßÂà∂Âàó -->
        <div class="bottom-controls">
            <button id="captureBtn" class="control-btn capture-btn" title="ÊãçÁÖß">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>ÊãçÁÖß</span>
            </button>

            <button id="recordBtn" class="control-btn record-btn" title="ÈåÑÂΩ±">
                <svg class="record-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="8" stroke="currentColor" stroke-width="2" fill="currentColor"/>
                </svg>
                <svg class="stop-icon hidden" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="6" y="6" width="12" height="12" stroke="currentColor" stroke-width="2" fill="currentColor"/>
                </svg>
                <span class="record-text">ÈåÑÂΩ±</span>
                <span class="stop-text hidden">ÂÅúÊ≠¢</span>
            </button>

            <a id="downloadLink" class="control-btn download-btn hidden" download title="‰∏ãËºâ">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>‰∏ãËºâ</span>
            </a>
        </div>

        <!-- ÊèêÁ§∫Ë®äÊÅØ -->
        <div id="hintMessage" class="hint-message">
            <p>üì± Â∞áÁõ∏Ê©üÂ∞çÊ∫ñ Hiro Ê®ôË®ò</p>
            <a href="marker.html" target="_blank" class="marker-link">Êü•ÁúãÊ®ôË®òÂúñÁâá</a>
        </div>
    </div>

    <!-- Chroma Key Shader -->
    <script>
        // Ë®ªÂÜäÁ∂†ÂπïÂéªËÉå shader
        AFRAME.registerShader('chromakey', {
            schema: {
                src: {type: 'map'},
                color: {type: 'color', default: '0.1 0.9 0.2'},
                transparent: {type: 'boolean', default: true},
                opacity: {type: 'number', default: 1.0}
            },
            
            init: function(data) {
                const videoTexture = new THREE.VideoTexture(data.src);
                videoTexture.minFilter = THREE.LinearFilter;
                videoTexture.magFilter = THREE.LinearFilter;
                videoTexture.format = THREE.RGBFormat;
                
                this.material = new THREE.ShaderMaterial({
                    uniforms: {
                        tex: {type: 't', value: videoTexture},
                        keyColor: {type: 'v3', value: new THREE.Vector3(0.1, 0.9, 0.2)},
                        similarity: {type: 'f', value: 0.4},
                        smoothness: {type: 'f', value: 0.1},
                        opacity: {type: 'f', value: data.opacity}
                    },
                    vertexShader: `
                        varying vec2 vUv;
                        void main() {
                            vUv = uv;
                            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                        }
                    `,
                    fragmentShader: `
                        uniform sampler2D tex;
                        uniform vec3 keyColor;
                        uniform float similarity;
                        uniform float smoothness;
                        uniform float opacity;
                        varying vec2 vUv;
                        
                        void main() {
                            vec4 videoColor = texture2D(tex, vUv);
                            
                            float Y1 = 0.299 * keyColor.r + 0.587 * keyColor.g + 0.114 * keyColor.b;
                            float Cr1 = keyColor.r - Y1;
                            float Cb1 = keyColor.b - Y1;
                            
                            float Y2 = 0.299 * videoColor.r + 0.587 * videoColor.g + 0.114 * videoColor.b;
                            float Cr2 = videoColor.r - Y2;
                            float Cb2 = videoColor.b - Y2;
                            
                            float blend = smoothstep(similarity, similarity + smoothness, distance(vec2(Cr2, Cb2), vec2(Cr1, Cb1)));
                            
                            gl_FragColor = vec4(videoColor.rgb, videoColor.a * blend * opacity);
                        }
                    `,
                    transparent: true,
                    side: THREE.DoubleSide
                });
            }
        });
    </script>

    <!-- ‰∏ªË¶Å JavaScript -->
    <script src="ar-controls.js"></script>
</body>
</html>

